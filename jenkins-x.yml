buildPack:  maven-java11
pipelineConfig:
  agent:
    image: caladreas/jx-builder-graalvm-maven-jdk11:v0.7.0
  pipelines:
    overrides:
      - name: mvn-install
        stage: build
        containerOptions:
          env:
            - name: _JAVA_OPTIONS
              value: >-
                -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler
                -Xms8g -Xmx8g -XX:+PrintCommandLineFlags -XX:+UseSerialGC
          resources:
            requests:
              cpu: "2"
              memory: 10Gi
            limits:
              cpu: "2"
              memory: 10Gi
        steps:
          - name: mvn-install
            command: mvn -Pnative clean package -e --show-version -DskipDocs
            env:
              - name: _JAVA_OPTIONS
                value: >-
                  -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler
                  -Xms8g -Xmx8g -XX:+PrintCommandLineFlags -XX:+UseSerialGC
      - name: mvn-deploy
        stage: build
        containerOptions:
          env:
            - name: _JAVA_OPTIONS
              value: >-
                -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler
                -Xms8g -Xmx8g -XX:+PrintCommandLineFlags -XX:+UseSerialGC
          resources:
            requests:
              cpu: "2"
              memory: 10Gi
            limits:
              cpu: "2"
              memory: 10Gi
        steps:
          - name: mvn-deploy
            command: mvn -Pnative clean package -e --show-version -DskipDocs
            env:
              - name: _JAVA_OPTIONS
                value: >-
                  -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler
                  -Xms8g -Xmx8g -XX:+PrintCommandLineFlags -XX:+UseSerialGC
      - name: mvn-deploy
        stage: build
        containerOptions:
          envFrom:
            - secretRef:
                name: jx-quarkus-demo-01-sonar
        step:
          name: print-env
          command: env
        type: after
      - name: print-env
        stage: build
        containerOptions:
          envFrom:
            - secretRef:
                name: jx-quarkus-demo-01-sonar
        step:
          name: sonar
          command: mvn compile org.sonarsource.scanner.maven:sonar-maven-plugin:3.6.0.1398:sonar -Dsonar.host.url="$SONAR_HOST_URL" -e --show-version -DskipTests=true
        type: after
      - name: sonar
        stage: build
        containerOptions:
          envFrom:
            - secretRef:
                name: sonatype-oss-index
        step:
          name: sonatype-ossindex
          command: mvn
          args:
            - org.sonatype.ossindex.maven:ossindex-maven-plugin:audit
            - -f
            - pom.xml
            - -Dossindex.scope=compile
            - -Dossindex.reportFile=ossindex.json
            - -Dossindex.cvssScoreThreshold=4.0
        type: after


